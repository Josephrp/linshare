## How to add new emails on the backend

To add emails in the backend LinShare you must follow the following steps :

##### 0 -  before you start

Before you begin this task, you must make sure that you have the latest update of the emails on your database, it is required for the next steps.

##### 1 -  Identify the data that will be displayed in the mail

At first, you need to identify the context of the email and the required variables.

    Example : Sender, Recipient, Objects ...

##### 2 -  Insert empty email template

There is some tables in database to store our emails' templates, however you need to insert an empty template for all new mails.

Use the script shell `add.new.mails.sh <offset> <count>` to generate the new `mail_content` and three `mail_content_lang` for each mail.

You will find this script in the following directory :  `linshare-core/src/main/resources/sql/postgresql`

###### Usage
```
    ./add.new.mails.sh <offset> <count>
    first param : offset (the sql id of the last mail content)
                  select id from mail_content order by id desc limit 1;

    second param : count (number of new email to generate)
```

##### 3 - Activate the email

For each added email content, we have to add a related mail_activation entry. It will allow administrators to enable or disable mail notifications through `ui-admin`

###### Usage
```
    ./add.new.activations.sh <offset> <policy_id> <names>

    first param : offset (the sql id of the last mail activation)
                  select id from mail_activation order by id desc limit 1;

    second param : policy_id (the sql id of the last policy)
                   select id from policy order by id desc limit 1;

    third param : a list of mail activation identifiers

    ex: ./add.new.activations.sh 16 230 SHARE_WARN_RECIPIENT_ABOUT_EXPIRED_SHARE UPLOAD_REQUEST_ACTIVATED_FOR_OWNER
```

**Important:**

* Insert the SQL code generated by the script in LinShare database

##### 4 -  Add the type of the new email (Enum)

It is necessary to add an enum kind for the new mail in java enums :  `MailActivationType` and `MailContentType`.

* Naming convention

[prefix]\_[Subject]

  - [Prefix], example : SHARE, UPDATE, GUEST ...
  - [subject] example : WARN_OWNER_ABOUT_GUEST_EXPIRATION ...

##### 5 - Create the emailContext and EmailBuilder

You can now create the  `YourNewEmailContext` andÂ `YourNewMailEmailBuilder` java classes

* EmailContext
* EmailBuilder:
    - Create the fakeBuild to test the Email in ui-admin.
    - Create the Build with all the required variables.

##### 6 - Add the mail to the building service

Add your new builder in `MailBuildingServiceImpl`

##### 7 - Write the content of the template

On the `ui-admin` you need to write the template content, go on left menu, `Mails -> Mail content`, you should find all your new mails' Enums, select one and now you can write your template message content by introducing the Subject, Body and your mails in English, French and Russian.

**Note:**

To be able to update the default mail contents you need to update your `linshare.properties` file (located on your `configurations/my_conf1` folder) and set to `True` the following variables :

    linshare.notifications.email.templating.override.readonly.mode=true
    linshare.notifications.email.templating.subject.prefix.enable=true

Do not forget to save all your changes and use the preview to test your work.

##### 8 - Update the existent templates

After updating mails from `ui-admin` you need to run the python script `app.py` located under `/linshare-core/utils/import_mails/` to retrieve all saved mails on the DB and update the SQL files stored in your git repository.

>**NB:** You should never update the MAIL.sql files manually.

Before launching the `app.py` script you need to verify your database's configuration in `config.default.json` file:

```
{
	"dbname": "linshare",
	"user": "linshare",
	"host": "localhost",
	"port": "5432",
	"password": "linshare",
	"path_mail_content_types": "../../src/main/java/org/linagora/linshare/core/domain/constants/MailContentType.java"
}
```

##### 9 : Add JunitTest for the new email
* You nedd to test and check your new emails locally. that's why you need to write a test for all your new emails.

* Do not forget to update the total number of emails in the generic email testing class `MailConfigServiceImplTest`.

* Do not forget to start the "wiser" before the test and stop it at the end.
